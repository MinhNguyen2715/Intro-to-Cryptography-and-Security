def detect_reuse(ciphertexts):
    """
    input: list of (gˆb, y) pairs
    output: dict mapping each gˆb to list of indices of ciphertexts that share that gˆb
    must run in O(N)
    """
    result = dict()
    for i, (c1, y) in enumerate(ciphertexts):
        if c1 not in result:
            result[c1] = [i]
        else:
            result[c1].append(i)
    return result

def recover_with_known_plain(group_indices, known_index, ciphertexts, x_known, p):
    """
    input:
    group_indices: indices that share the same gˆb (nonce reuse group)
    known_index: one index in that group for which plaintext x_known is known
    ciphertexts: list of (gˆb, y) pairs
    x_known: known plaintext
    p: modulus

    output:
    dict: index -> recovered plaintext for all indices in the group
    """
    target_group = None
    for group in group_indices:
        if known_index in group:
            target_group = group
            break

    if target_group is None:
        return {}

    y_known = ciphertexts[known_index][1]
    inv_x_known = pow(x_known, -1, p)

    g_ab = (y_known * inv_x_known) % p
    inv_g_ab = pow(g_ab, -1, p)

    recovered = {}
    for i in target_group:
        y = ciphertexts[i][1]
        recovered[i] = (y * inv_g_ab) % p

    return recovered

if __name__ == "__main__":
    p = 95552571855512758838931826791459251019769786805418331004116987637225501521453
    g = 2
    g_a = 30830235116662899284371888138332536123855106370370527317876741729102828038282 % p

    # ciphertext: (g^b, y)
    ciphertexts =[(61078443944907540135559149192518503315098864116780697835784992182229203100944,38922467505518474804448446761511814375029180030267443666344772743527104310635),(94027116721640382560628901552325318322340406357085853531014337257321040276214,83672438047882773416302643979814814719892762945915539393325554355223431015057),(94027116721640382560628901552325318322340406357085853531014337257321040276214,36996698308698519852950607205684006956693722239972008639302184484580393692085),(94027116721640382560628901552325318322340406357085853531014337257321040276214,34838938810801520758174491006846279889506248592091881677456438500519105251633),(94027116721640382560628901552325318322340406357085853531014337257321040276214,35013762552715112813296642254598686540240360520740723533849051769108022396264),(61078443944907540135559149192518503315098864116780697835784992182229203100944,38922467505518474804448446761511814375029180030267443666344772743527104310635), (31582246140190397042889825940781403162886294643931483639505918117179207554036,48642035245166085663672810883666533146635477335283141688082508969322891629011),(12753568787377827777069626163612201165222606771373551616795740342836030919950,8154202338300051424566705827673382752034428560600667817962752577194793250903)]

    # Known plaintext you must use:
    # plaintext for index 1 is known:
    x_1 = 210315799752932871275385655158625349661

    # Expected recovered plaintexts (to verify):
    # x_2 = 11414817998352517241632511775950081130644924184707708450948131510278612237527
    # x_3 = 37647135417842058436058856581393711404732674393379078241248765292980707272523
    # x_4 = 83255510639352351944296738375247527864920310643882061203234015571496556961717

    reuse = detect_reuse(ciphertexts)
    group_indices = list(reuse.values())

    result = recover_with_known_plain(group_indices, 1, ciphertexts, x_1, p)
    group_result = list(result.items())
    print(*group_result,sep="\n")


